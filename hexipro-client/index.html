<html>

<head>
  <title>Hexipro</title>
  <link rel="stylesheet" href="game.css">
  <style>

    h1 {
      margin-bottom: 0;
      /* padding: 0;
      margin: 0; */
    }

    #canvas {
      background-color: #0d0d0d;
      border: 0;
      border-radius: 10px;
    }

    #player {
      color: var(--hexipro-green);
    }

    #stage {
      color: var(--hexipro-green);
    }

    #power {
      color: var(--hexipro-violet)
    }
  </style>
</head>

<body>
  <h1>Hexipro</h1>
  <hr class="rainbow-divider">
  <div id="hexipro">
    <p>
        Player: <span id="player">PLAYER</span><br>
        Stage: <span id="stage">STAGE</span><br>
        Power: <span id="power">0 </span>
    </p>
    <canvas id="canvas" width="1000" height="700"></canvas>
  </div>
  <script>
    var canvas = document.getElementById('canvas');
    var ctx = canvas.getContext('2d');

    // Game Tile object to handle rendering and
    // listen for clicks
    class HexagonTile {

      colorOverride = null;

      constructor(c, r, cx, cy, size, player, power, active) {
        this.c = c;
        this.r = r;
        this.cx = cx;
        this.cy = cy;
        this.size = size;
        this.player = player;
        this.power = power;
        this.active = active;

        // this.draw();
      }

      draw = () => {
        let size = this.size;
        let cx = this.cx;
        let cy = this.cy;
        let power = this.power;
        let player = this.player;
        let active = this.active;
        let c = this.c;
        let r = this.r;

        if (!active) {
          return;
        }

        let drawSize = size - (0.15 * size);

        const hexagon = new Path2D();
        ctx.beginPath();
        hexagon.moveTo(cx + drawSize * Math.cos(0), cy + drawSize * Math.sin(0));

        for (let i = 1; i <= 6; i += 1) {
          hexagon.lineTo(cx + drawSize * Math.cos(i * Math.PI / 3), cy + drawSize * Math.sin(i * Math.PI / 3));
        }

        // end path
        ctx.closePath();

        // let playerLineColor = palette.green;
        let playerLineColor = palette.dark_gray;
        let playerFillColor = palette.background;

        if (player === 'A') {
          playerLineColor = palette.light_teal;
          playerFillColor = palette.light_teal;
        } else if (player === 'B') {
          playerLineColor = palette.dark_teal;
          playerFillColor = palette.dark_teal;
        }

        // canvas.addEventListener('mousemove', function (event) {
        //   if (ctx.isPointInPath(hexagon, event.offsetX, event.offsetY)) {
        //     console.log('point is in path of (' + c + ', ' + r + ')');
        //   }
        // });

        canvas.addEventListener('click', function (event) {
          if (ctx.isPointInPath(hexagon, event.offsetX, event.offsetY)) {
            GameTiles[c][r].colorOverride = 'white;'
            GameTiles[c][r].draw();
            console.warn('POINT CLICKED');

            // pass this event on to be handled by client game logic
            // (then passed onto server if event is valid)

            // @TODO validateTileClick(c, r);
          }
        });

        // player fill
        ctx.fillStyle = this.colorOverride ? this.colorOverride : playerFillColor;
        ctx.fill(hexagon);

        //canvas.addHitRegion({ id: `tile-col-${c}-row-${r}` });

        // dark gap/outline
        ctx.strokeStyle = palette.background;
        ctx.lineWidth = 15;
        ctx.stroke(hexagon);

        // player outline
        ctx.strokeStyle = playerLineColor;
        ctx.lineWidth = 3;
        ctx.stroke(hexagon);

        // power text
        let fontStyle = `${Math.floor(drawSize / 3)}px sans-serif`;
        ctx.font = fontStyle;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = 'white';
        // ctx.fillText(`(${c},${r}) ${power}`, cx, cy, drawSize);
        ctx.fillText(`${power}`, cx, cy, drawSize);

        this.update();
      };

      update = () => {

      };
    };

    const stages = [
      'attack',
      'allocate'
    ];

    let game = {
      currentPlayer: 'A',
      nextPlayer: 'B',
      selectedTile: null,
      stage: 'attack',
      // connection flags
      pendingConfirmation: false,
      waitingForTurn: false
    };

    let palette = {
      background: '#0d0d0d',
      blue: '#29C2DE',
      green: '#26C99E',
      indigo: '#CC78FA',
      violet: '#C724B1',
      dark_teal: '#005151',
      light_teal: '#30CEBB',
      white: '#FFFFFF',
      dark_gray: '#53565A'
    };

    const size = 50;
    var HexColumns = 12;
    var HexRows = 7;
    var HexSetup = [
      [
        { player: 'A', power: 2, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
      ],
      [
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
      ],
      [
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
      ],
      [
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
      ],
      [
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
      ],
      [
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
      ],
      [
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
      ],
      [
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
      ],
      [
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
      ],
      [
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
      ],
      [
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
      ],
      [
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: null, power: 0, active: true },
        { player: 'B', power: 2, active: true }
      ]
    ];
    let GameTiles = [];
    createTiles(HexSetup, HexColumns, HexRows);

    function animate() {
      //requestAnimationFrame(animate);
      ctx.clearRect(0, 0, 1280, 800);
      GameTiles.forEach(column => {
        column.forEach(tile => {
          tile.draw();
        });
      });
    }

    animate();

    function getCenter(col, row) {

      let x = size + col * (size + size / 2);
      let y = size + row * (size * Math.sqrt(3)) + ((col % 2) * (size * (Math.sqrt(3) / 2)));

      return { x, y }
    }

    function createTiles(tileSetup, columns, rows) {
      // initialize tiles with coordinates
      for (let col = 0; col < columns; col++) {
        GameTiles.push([]);
        for (let row = 0; row < rows; row++) {
          let center = getCenter(col, row);
          let setup = tileSetup[col][row];

          let player = setup.player;
          let power = setup.power;
          let active = setup.active;

          let newTile = new HexagonTile(
            col, row,
            center.x, center.y, size,
            player, power,
            active
          );

          GameTiles[col].push(newTile);
        }
      }
    }

    // Set up WebSocket connection to game server
    var url = 'wss://exampleurl.com/socketserver';
    var protocol = 'exampleProtocol';
    var socket = new WebSocket(url, protocol);

    // Listen for events from the game server
    socket.onmessage = function(event) {
      console.log(event.data);

      /*
        handle incoming event:
        - update local game state
        - render the board - animate();
        - ...?
      */
    }

    // Send an event to the game server
    function sendAction(c, r, type) {
      // let the local game state know it should wait
      // for this action to be received/validated 
      // by the server

      
      var msg = {
        column: c,
        row: r,
        action: type
      };

      socket.send(JSON.stringify(msg));
    }

  </script>
  <script src="./board.js"></script>
  <script src="./tile.js"></script>
  <script src="./player.js"></script>
  <script> var board = new Board(12,7)</script>
</body>

</html>